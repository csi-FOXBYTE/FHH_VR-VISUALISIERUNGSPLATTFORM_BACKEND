# WebBackend - Working With This Repository

This backend is a Fastify + TypeScript service that uses Prisma/ZenStack for the data model, BullMQ for background work, and `@csi-foxbyte/fastify-toab` for dependency injection/registration of services, controllers, and workers. The ZenStack schema is authored in the frontend repo and copied into this backend before code generation. Use pnpm for all commands; Node.js 20+ is recommended (Node 23 is used in the devcontainer).

## Project Layout
- `zmodel/`: ZenStack schemas copied from the frontend (source of truth).
- `prisma/schema.prisma`: Generated from `zmodel/schema.zmodel` (do not edit directly).
- `src/`: Application code; each feature has `*.service.ts`, `*.controller.ts`, optional `workers/`.
- `src/@internals/index.ts`, `src/registries.ts`: Auto-generated registries/helpers from `fastify-toab`.
- `bin/`: Native tools used by converters.
- Tooling: esbuild/tsx for dev+build (`pnpm dev` / `pnpm build`), pnpm 10, Node 23 (per `.devcontainer`).

## Prerequisites & Environment
- pnpm 10 (`corepack enable pnpm`) â€” pnpm is required for this project.
- Node.js 20+ recommended (Node 23 in the devcontainer).
- PostgreSQL reachable via `DATABASE_URL`.
- Redis via `REDIS_CONNECTION_STRING` (set `REDIS_IS_CLUSTER=true` for cluster).
- Azure storage via `AZURE_STORAGE_CONNECTION_STRING`.
- Auth secrets: `AUTH_SECRET` (base64 encoded) and `PORT` for the HTTP server.
- Optional: `APPLICATIONINSIGHTS_CONNECTION_STRING`, `WORKER_DISABLED=true` (skip worker init), `DISABLED_WORKERS=true` (skip worker startup inside workers).
- Install dependencies: `pnpm install`.

### Running Locally
- Start required services (PostgreSQL, Redis, optional Azure emulator).
- `pnpm dev` - incremental build to `.dev` with automatic server restarts.
- `pnpm build` - production build to `.build`.
- `pnpm lint` - linting.

## Adding Things

### 1) Update the Data Model (ZenStack/Prisma)
1. Make schema changes in the frontend repo (the ZenStack source of truth lives there).
2. Copy the updated `zmodel/*.zmodel` files into this repo's `zmodel/` directory.
3. Regenerate Prisma/ZenStack output: `pnpm zenstack-generate` (writes `prisma/schema.prisma`).
4. Sync the database schema: `pnpm exec prisma db push` for quick dev sync, or `pnpm exec prisma migrate dev --name <change>` if you want a migration file.
5. Regenerate Prisma client if needed: `pnpm exec prisma generate`.
6. Update services/controllers to use the new model, preferring `getDbService` (ZenStack policy-enforced) over `getPrismaService` unless you intentionally bypass policies.

### 2) Add a New Service and HTTP Endpoints
1. Scaffold with Toab (creates folders for you): `pnpm fastify-toab create service <name>` and `pnpm fastify-toab create controller <name>`.
2. Implement business logic in the generated service using `createService("name", async ({ services }) => { ... }, { scope: "REQUEST" })` and consume other services via the helpers from `src/@internals/index.ts`.
3. Define DTOs with `@sinclair/typebox` (see existing `*.dto.ts` files).
4. Wire routes in the generated controller using `createController().rootPath("/your-path")`; attach `authMiddleware` where required and add `.body()`, `.params()`, `.query()`, `.output()` for validation/typing.
5. Run `pnpm fastify-toab rebuild` to regenerate `src/registries.ts` and `src/@internals/index.ts` so the new service/controller is wired into Fastify. Do not hand-edit the generated files.
6. Restart the dev server if it was running.

### 3) Add a Background Worker (BullMQ)
1. Scaffold with Toab (creates folders automatically): `pnpm fastify-toab create worker <name>`.
2. Implement the generated worker using `createWorker()`, set a queue name, connection (`defaultConnection` from `src/connection.ts`), and optional schedulers (`.upsertJobScheduler`).
3. Implement the `processor` to call your services via the helper getters.
4. Regenerate registries with `pnpm fastify-toab rebuild` so the worker is registered and its queue exposed.
5. Use `WORKER_DISABLED=true` to skip worker initialization when you only want HTTP routes running.

### 4) Working With Data Access
- Use `getDbService` for requests that must respect ZenStack `@allow/@deny` rules tied to the current session.
- Use `getPrismaService` only when you intentionally need raw Prisma access (e.g., startup tasks).
- Cache helpers live in `cacheService`, blob access in `blobStorageService`, authentication/session info in `authService`.

## Autogenerated Files - Do Not Edit by Hand
- `prisma/schema.prisma` (from ZenStack).
- `src/registries.ts` and `src/@internals/index.ts` (from `pnpm fastify-toab rebuild`).
- Files marked with `AUTOGENERATED!` comments are regenerated by tooling; change the source (service/controller/worker or zmodel) and re-run the relevant generator instead.

## Build & Release
- `pnpm build` - production build (outputs to `.build`).
- `pnpm publish:docker` - build/tag/push the Docker image (uses `package.json` version).

Follow these steps when you add models, routes, or workers so the generated artifacts stay in sync with the frontend-owned ZenStack schema and the Fastify registries.
